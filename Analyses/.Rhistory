allom.sp <- lm.rrpp(LS.mns~sz.mn, Cov = C)
allom.ind <- lm.rrpp(shape~svl, data = rdf)
anova(allom.sp)
anova(allom.ind)
M <-rbind(coef.evol <- allom.sp$LM$gls.coefficients[2,],
coef.ind <- allom.ind$LM$coefficients[2,])
M <-rbind(coef.evol <- allom.sp$LM$gls.coefficients[2,],
coef.ind <- allom.ind$LM$coefficients[2,],
coef.iso <- c(1,1,1,1,1,1,1,1))
acos(RRPP:::vec.cor.matrix(M))*180/pi  #virtually parallel (angle of 1.49 degrees)
# 2: MANCOVA & comparison of allometry among habitats
fit.hab <- lm.rrpp(shape~svl*habitat, data = rdf)
anova(fit.hab)
pw.hab1 <- pairwise(fit.hab, groups = rdf$habitat, covariate = rdf$svl)
summary(pw.hab1, type = 'VC', stat.table = FALSE)
# 2A: Compare evolutionary and static (habitat) allometry
fit.0 <- lm.rrpp(shape~habitat, data = rdf) #H_0: group differences only (no allometry)
pw.hab <- pairwise(fit.hab, fit.null = fit.0, groups = rdf$habitat, covariate = rdf$svl)
slp.hab <- pw.hab$slopes[[1]] #slopes by habitat
slp.hab
###### ISOMETRY
acos(RRPP:::vec.cor.matrix(rbind(slp.hab,coef.iso)))*180/pi
## test against isometry
#need to get intercepts, predicted, residuals
#fit full model,
# slopes: compare
mn.sz <- mean(rdf$svl)
mn.shape <- apply(rdf$shape,2,mean)
slopes <- rep(1,ncol(rdf$shape))
slopes
intercepts <- mn.shape - (slopes * mn.sz)
X <- cbind(1,rdf$svl)
b <- rbind(intercepts,slopes)
preds <- X%*%b
preds
E.iso <- rdf$shape - preds
M <-rbind(coef.evol <- allom.sp$LM$gls.coefficients[2,],
coef.ind <- allom.ind$LM$coefficients[2,],
coef.iso <- c(1,1,1,1,1,1,1,1))
acos(RRPP:::vec.cor.matrix(M))*180/pi  #virtually parallel (angle of 1.49 degrees)
###### ISOMETRY
coef.iso <- c(1,1,1,1,1,1,1,1)
acos(RRPP:::vec.cor.matrix(rbind(slp.hab,coef.iso)))*180/pi
# 2B: Compare evolutionary and static (habitat) allometry
fit.0 <- lm.rrpp(shape~habitat, data = rdf) #H_0: group differences only (no allometry)
fit.0$LM
fit.iso <- lm.rrpp(shape~svl,data = rdf)
fit.iso$ANOVA
fit.iso$LM
fit.hab$LM$n
perms <- RRPP:::perm.index(n = fit.hab$LM$n, iter = 999)
perms[[1]]
perms[[1000]]
lm.rrpp((preds+E.iso[[1]]) ~ rdf$svl*rdf$habitat, iter=0)
pairwise(lm.rrpp((preds+E.iso[[1]]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)
pairwise(lm.rrpp((preds+E.iso[[1]]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
pairwise(lm.rrpp((preds+E.iso[[2]]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
pairwise(lm.rrpp((preds+E.iso[[2]]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes
pairwise(lm.rrpp((preds+E.iso[perms[[1]]],) ~ rdf$svl*rdf$habitat, iter=0),
dim(E.iso)
pairwise(lm.rrpp((preds+E.iso[perms[[1]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
pairwise(lm.rrpp((preds+E.iso[perms[[2]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
pairwise(lm.rrpp((preds+E.iso[perms[[3]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
slopes <- lapply(1:1000, function(j) {
pairwise(lm.rrpp((preds+E.iso[perms[[j]],]) ~
rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
})
pairwise(lm.rrpp((preds+E.iso[perms[[1]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
slopes <- lapply(1:1000, function(j) pairwise(lm.rrpp((preds+E.iso[perms[[j]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]])
rdf$preds <- X%*%b
rdf$E.iso <- rdf$shape - preds
perms <- RRPP:::perm.index(n = fit.hab$LM$n, iter = 999)
slopes <- lapply(1:1000, function(j) pairwise(lm.rrpp((rdf$preds+rdf$E.iso[perms[[j]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]])
slopes <- lapply(1:1000, function(j) pairwise(lm.rrpp((rdf$preds+rdf$E.iso[perms[[j]],]) ~ rdf$svl*rdf$habitat,
data = rdf, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]])
slopes <- lapply(1:1000, function(j) pairwise(lm.rrpp((preds+E.iso[perms[[j]],]) ~ svl*habitat,
data = rdf, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]])
slopes <- lapply(1:1000, function(j) {
res <- lm.rrpp((preds + E.iso[perms[[j]],]) ~ rdf$svl*rdf$habitat, iter = 0 )
})
preds <- X%*%b
E.iso <- rdf$shape - preds
perms <- RRPP:::perm.index(n = fit.hab$LM$n, iter = 999)
slopes <- lapply(1:1000, function(j) {
res <- lm.rrpp((preds + E.iso[perms[[j]],]) ~ rdf$svl*rdf$habitat, iter = 0 )
})
res <- lm.rrpp((preds + E.iso[perms[[j]],]) ~ svl*habitat, iter = 0, data = rdf )
slopes <- lapply(1:1000, function(j) {
Y <- preds + E.iso[perms[[j]],]
res <- lm.rrpp(Y ~ rdf$svl*rdf$habitat, iter = 0)
})
pairwise(lm.rrpp((rdf$preds+rdf$E.iso[perms[[1]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]])
pairwise(lm.rrpp((rdf$preds+rdf$E.iso[perms[[1]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
pairwise(lm.rrpp((preds+E.iso[perms[[1]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
libs <- c('geomorph', 'RRPP', 'phytools', 'geiger', 'tidyverse')
easypackages::libraries(libs)
# 0: Data Prep
data0 <- read.table('data/morpho/morpho_pristurus.csv', sep = ';', dec = '.', header = TRUE, stringsAsFactors = TRUE)
sp.to.keep <- names(which(table(data0$species) >= 5))
data <- data0[data0$species %in% sp.to.keep, ]
data$species <- droplevels(data$species)
data$SVL <- log(data$SVL)
shape <- as.matrix(log(data[, 8:ncol(data)]))
rdf <- rrpp.data.frame(svl = data$SVL, shape = shape, habitat = data$habitat_broad, species = data$species)
tree0 <- read.nexus('data/phylogeny/pristurus_tree_final.nex')
LS.mns <- pairwise(lm.rrpp(shape~species, data = rdf, iter=0), groups = rdf$species)$LS.means[[1]]
sz.mn <- tapply(rdf$svl,rdf$species,mean)
hab.mn <- as.factor(by(rdf$habitat,rdf$species,unique))
levels(hab.mn) <- levels(rdf$habitat)
tree <- treedata(phy = tree0, data = LS.mns)$phy
C <- vcv.phylo(tree)
# 1: Evolutionary Allometry
allom.sp <- lm.rrpp(LS.mns~sz.mn, Cov = C)
allom.ind <- lm.rrpp(shape~svl, data = rdf)
anova(allom.sp)
anova(allom.ind)
M <-rbind(coef.evol <- allom.sp$LM$gls.coefficients[2,],
coef.ind <- allom.ind$LM$coefficients[2,])
allom.ind <- lm.rrpp(shape~svl, data = rdf)
anova(allom.sp)
anova(allom.ind)
M <-rbind(coef.evol <- allom.sp$LM$gls.coefficients[2,],
coef.ind <- allom.ind$LM$coefficients[2,])
acos(RRPP:::vec.cor.matrix(M))*180/pi  #virtually parallel (angle of 1.49 degrees)
# 2: MANCOVA & comparison of allometry among habitats
fit.hab <- lm.rrpp(shape~svl*habitat, data = rdf)
anova(fit.hab)
pw.hab1 <- pairwise(fit.hab, groups = rdf$habitat, covariate = rdf$svl)
summary(pw.hab1, type = 'VC', stat.table = FALSE)
# 2A: Compare habitat vectors versus isometry
mn.sz <- mean(rdf$svl)
mn.shape <- apply(rdf$shape,2,mean)
intercepts <- mn.shape - (coef.iso * mn.sz)
X <- cbind(1,rdf$svl)
b <- rbind(intercepts,coef.iso)
rdf$preds <- X%*%b
rdf$E.iso <- rdf$shape - preds
perms <- RRPP:::perm.index(n = fit.hab$LM$n, iter = 999)
slopes <- lapply(1:1000, function(j) {
Y <- preds + E.iso[perms[[j]],]
res <- lm.rrpp(Y ~ rdf$svl*rdf$habitat, iter = 0)
})
preds <- X%*%b
E.iso <- rdf$shape - preds
perms <- RRPP:::perm.index(n = fit.hab$LM$n, iter = 999)
slopes <- lapply(1:1000, function(j) {
Y <- preds + E.iso[perms[[j]],]
res <- lm.rrpp(Y ~ rdf$svl*rdf$habitat, iter = 0)
})
preds <- X%*%b
X <- cbind(1,rdf$svl)
b <- rbind(intercepts,coef.iso)
# 2A: Compare habitat vectors versus isometry
mn.sz <- mean(rdf$svl)
mn.shape <- apply(rdf$shape,2,mean)
intercepts <- mn.shape - (coef.iso * mn.sz)
# 2A: Compare habitat vectors versus isometry
mn.sz <- mean(rdf$svl)
mn.shape <- apply(rdf$shape,2,mean)
coef.iso <- c(1,1,1,1,1,1,1,1)
intercepts <- mn.shape - (coef.iso * mn.sz)
X <- cbind(1,rdf$svl)
b <- rbind(intercepts,coef.iso)
preds <- X%*%b
E.iso <- rdf$shape - preds
perms <- RRPP:::perm.index(n = fit.hab$LM$n, iter = 999)
slopes <- lapply(1:1000, function(j) {
Y <- preds + E.iso[perms[[j]],]
res <- lm.rrpp(Y ~ rdf$svl*rdf$habitat, iter = 0)
})
pairwise(lm.rrpp((rdf$preds+rdf$E.iso[perms[[1]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
pairwise(lm.rrpp((preds+E.iso[perms[[1]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
slopes <- lapply(1:1000, function(j) {
pairwise(lm.rrpp((preds+E.iso[perms[[1]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
})
slopes
slopes <- lapply(1:1000, function(j) {
pairwise(lm.rrpp((preds+E.iso[perms[[j]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
})
perms
perms$iter.1
perms[[1]]
perms[[2]]
for(j in 1:2){
pairwise(lm.rrpp((preds+E.iso[perms[[j]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
}
slopes <- list()
for(j in 1:2){
slopes[[j]] <- pairwise(lm.rrpp((preds+E.iso[perms[[j]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
}
slopes[[1]]
slopes[[2]]
slopes <- list()
for(j in 1:1000){
slopes[[j]] <- pairwise(lm.rrpp((preds+E.iso[perms[[j]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
}
slp.ang <- lapply(1:1000, function(j) acos(RRPP:::vec.cor.matrix(rbind(coef.iso,slopes[[j]])))*180/pi)
slp.hab.obs <- slp.ang[[1]]
slp.Z <- RRPP:::effect.list(slp.ang)
slp.P <- RRPP:::Pval.list(slp.ang)
slp.P <-1-slp.P; diag(slp.P) <- 1 #test for similar (not different)
slp.hab.obs
slp.Z
slp.P
slp.P <- RRPP:::Pval.list(slp.ang)
slp.P
###### ISOMETRY
coef.iso <- c(1,1,1,1,1,1,1,1)
acos(RRPP:::vec.cor.matrix(rbind(slp.hab,coef.iso)))*180/pi
# 2B: Compare evolutionary and static (habitat) allometry
fit.0 <- lm.rrpp(shape~habitat, data = rdf) #H_0: isometry
pw.hab <- pairwise(fit.hab, fit.null = fit.0, groups = rdf$habitat, covariate = rdf$svl)
slp.hab <- pw.hab$slopes[[1]] #slopes by habitat
###### ISOMETRY
coef.iso <- c(1,1,1,1,1,1,1,1)
acos(RRPP:::vec.cor.matrix(rbind(slp.hab,coef.iso)))*180/pi
slp.hab
slp.hab.obs
slp.hab
slopes[[1]]
slp.ang <- lapply(1:1000, function(j) acos(RRPP:::vec.cor.matrix(rbind(slopes[[j]],coef.iso)))*180/pi)
slp.hab.obs <- slp.ang[[1]]
slp.Z <- RRPP:::effect.list(slp.ang)
slp.P <- RRPP:::Pval.list(slp.ang)
slp.hab.obs
slp.Z
slp.P  #all differ from isometry, and ground differs from rock and tree
summary(pw.hab1, type = 'VC', stat.table = FALSE)
slp.P <- RRPP:::Pval.list(slp.ang)
slp.hab.obs
slp.Z
slp.P  #all differ from isometry, and ground differs from rock and tree
slp.hab
slp.hab.obs
slopes[[1]]
coef.evol
# 2B: Compare evolutionary and static (habitat) allometry
#H_0: isometry
slp.ang.ev <- lapply(1:1000, function(j) acos(RRPP:::vec.cor.matrix(rbind(coef.evol,slopes[[j]])))*180/pi)
slp.hab.ev.obs <- slp.ang.ev[[1]]
slp.hab.ev.obs <- slp.ang.ev[[1]]
slp.Z.ev <- RRPP:::effect.list(slp.ang.ev)
slp.P.ev <- RRPP:::Pval.list(slp.ang.ev)
slp.hab.ev.obs
slp.Z.ev
slp.P.ev  #angles significantly smaller than expected
res <- cbind(slp.hab.obs.ev[-1,1],slp.Z.ev[-1,1],slp.P.ev[-1,1])
colnames(res) <- c("Angle","Effect Size", "P-value")
res <- cbind(slp.hab.ev.obs[-1,1],slp.Z.ev[-1,1],slp.P.ev[-1,1])
colnames(res) <- c("Angle","Effect Size", "P-value")
rownames(res) <- c("Ground", "Rock", "Tree")
res
slp.hab.obs
slp.Z
slp.P  #all differ from isometry, and ground differs from rock and tree
table(rdf$habitat)
res
RRPP:::perm.index(10,10)
RRPP:::perm.index(10,10)
RRPP:::perm.index(10,10, seed = "script_clean_main-DCA-11-04-Isometry.R")
lm.rrpp
?lm.rrpp
perms <- RRPP:::perm.index(n = fit.hab$LM$n, iter = 999, seed = "random")
slopes <- list()
for(j in 1:1000){
slopes[[j]] <- pairwise(lm.rrpp((preds+E.iso[perms[[j]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
}
slp.ang <- lapply(1:1000, function(j) acos(RRPP:::vec.cor.matrix(rbind(slopes[[j]],coef.iso)))*180/pi)
slp.hab.obs <- slp.ang[[1]]
slp.Z <- RRPP:::effect.list(slp.ang)
slp.P <- RRPP:::Pval.list(slp.ang)
slp.hab.obs
slp.Z
slp.P  #all differ from isometry, and ground differs from rock and tree
perms <- RRPP:::perm.index(n = fit.hab$LM$n, iter = 999, seed = "random")
slopes <- list()
for(j in 1:1000){
slopes[[j]] <- pairwise(lm.rrpp((preds+E.iso[perms[[j]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
}
slp.ang <- lapply(1:1000, function(j) acos(RRPP:::vec.cor.matrix(rbind(slopes[[j]],coef.iso)))*180/pi)
slp.hab.obs <- slp.ang[[1]]
slp.Z <- RRPP:::effect.list(slp.ang)
slp.P <- RRPP:::Pval.list(slp.ang)
slp.hab.obs
slp.Z
slp.P  #all differ from isometry, and ground differs from rock and tree
perms <- RRPP:::perm.index(n = fit.hab$LM$n, iter = 999, seed = "random")
slopes <- list()
for(j in 1:1000){
slopes[[j]] <- pairwise(lm.rrpp((preds+E.iso[perms[[j]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
}
slp.ang <- lapply(1:1000, function(j) acos(RRPP:::vec.cor.matrix(rbind(slopes[[j]],coef.iso)))*180/pi)
slp.hab.obs <- slp.ang[[1]]
slp.Z <- RRPP:::effect.list(slp.ang)
slp.P <- RRPP:::Pval.list(slp.ang)
slp.hab.obs
slp.Z
slp.P  #
perms <- RRPP:::perm.index(n = fit.hab$LM$n, iter = 999, seed = "random")
slopes <- list()
for(j in 1:1000){
slopes[[j]] <- pairwise(lm.rrpp((preds+E.iso[perms[[j]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
}
slp.ang <- lapply(1:1000, function(j) acos(RRPP:::vec.cor.matrix(rbind(slopes[[j]],coef.iso)))*180/pi)
slp.hab.obs <- slp.ang[[1]]
slp.Z <- RRPP:::effect.list(slp.ang)
slp.P <- RRPP:::Pval.list(slp.ang)
slp.hab.obs
slp.Z
slp.P
perms <- RRPP:::perm.index(n = fit.hab$LM$n, iter = 999)
slopes <- list()
for(j in 1:1000){
slopes[[j]] <- pairwise(lm.rrpp((preds+E.iso[perms[[j]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
}
slp.ang <- lapply(1:1000, function(j) acos(RRPP:::vec.cor.matrix(rbind(slopes[[j]],coef.iso)))*180/pi)
slp.hab.obs <- slp.ang[[1]]
slp.Z <- RRPP:::effect.list(slp.ang)
slp.P <- RRPP:::Pval.list(slp.ang)
slp.hab.obs
slp.Z
slp.P
coef(fit.hab)
intercepts
b
anova(lm.rrpp(shpae~habitat, data = rdf))
anova(lm.rrpp(shape~habitat, data = rdf))
fit.hab$LM$mean
coef(fit.hab)
coef(lm.rrpp(shape~svl+habitat, data = rdf))
coef(lm.rrpp(shape~svl, data = rdf))
mn.sz
#### DO this by group to find common slope model
mn.sz <- tapply(rdf$svl,habitat,mean)
#### DO this by group to find common slope model
mn.sz <- tapply(rdf$svl,rdf$habitat,mean)
mn.sz
mn.shape
mn.shape <- rowsum(rdf$shape, rdf$habitat)/as.vector(table(rdf$habitat))
mn.shape
coef.iso
mn.sz
coef.iso*mean(rdf.svl)
mean(rdf$svl)
coef.iso * mean(rdf$svl)
coef.iso %*% mn.sz
coef.iso %*% t(mn.sz)
t(coef.iso) %*% mn.sz
crossprod(coef.iso,mn.sz)
tcrossprod(coef.iso,mn.sz)
t(tcrossprod(coef.iso,mn.sz))
mn.shape
intercepts <- mn.shape - t(tcrossprod(coef.iso,mn.sz))
intercepts
# 2A: Compare habitat vectors versus isometry and to each other
#H_0: isometry as single slope
mn.sz <- mean(rdf$svl)
mn.shape <- apply(rdf$shape,2,mean)
coef.iso <- c(1,1,1,1,1,1,1,1)
intercepts <- mn.shape - (coef.iso * mn.sz)
intercepts
coef(fit.hab)
#### DO this by group to find common slope model
mn.sz <- tapply(rdf$svl,rdf$habitat,mean)
mn.shape <- rowsum(rdf$shape, rdf$habitat)/as.vector(table(rdf$habitat))
intercepts <- mn.shape - (coef.iso * mn.sz)
intercepts <- mn.shape - t(tcrossprod(coef.iso,mn.sz))
intercepts
intercepts-intercepts[1,]
intercepts[2,]-intercepts[1,]
b <- rbind(intercepts[1,],coef.iso,intercepts[2,]-intercepts[1,],
intercepts[3,]-intercepts[1,])
X <- cbind(1,rdf$svl)
preds <- X%*%b
model.matrix(rdf$svl)
model.matrix(~rdf$svl)
cbind(1,rdf$svl)
model.matrix~svl+habitat
model.matrix(~rdf$svl+rdf$habitat)
X <- model.matrix(~rdf$svl+rdf$habitat)
b <- rbind(intercepts[1,],coef.iso,intercepts[2,]-intercepts[1,],
intercepts[3,]-intercepts[1,])
preds <- X%*%b
preds
#### DO this by group to find common slope model
mn.sz <- tapply(rdf$svl,rdf$habitat,mean)
mn.shape <- rowsum(rdf$shape, rdf$habitat)/as.vector(table(rdf$habitat))
intercepts <- mn.shape - t(tcrossprod(coef.iso,mn.sz))
X <- model.matrix(~rdf$svl+rdf$habitat)
b <- rbind(intercepts[1,],coef.iso,intercepts[2,]-intercepts[1,],
intercepts[3,]-intercepts[1,])
preds <- X%*%b
E.iso <- rdf$shape - preds
perms <- RRPP:::perm.index(n = fit.hab$LM$n, iter = 999)
slopes <- list()
libs <- c('geomorph', 'RRPP', 'phytools', 'geiger', 'tidyverse')
easypackages::libraries(libs)
# 0: Data Prep
data0 <- read.table('data/morpho/morpho_pristurus.csv', sep = ';', dec = '.', header = TRUE, stringsAsFactors = TRUE)
sp.to.keep <- names(which(table(data0$species) >= 5))
data <- data0[data0$species %in% sp.to.keep, ]
data$species <- droplevels(data$species)
data$SVL <- log(data$SVL)
shape <- as.matrix(log(data[, 8:ncol(data)]))
rdf <- rrpp.data.frame(svl = data$SVL, shape = shape, habitat = data$habitat_broad, species = data$species)
tree0 <- read.nexus('data/phylogeny/pristurus_tree_final.nex')
LS.mns <- pairwise(lm.rrpp(shape~species, data = rdf, iter=0), groups = rdf$species)$LS.means[[1]]
sz.mn <- tapply(rdf$svl,rdf$species,mean)
hab.mn <- as.factor(by(rdf$habitat,rdf$species,unique))
levels(hab.mn) <- levels(rdf$habitat)
tree <- treedata(phy = tree0, data = LS.mns)$phy
C <- vcv.phylo(tree)
# 1: Evolutionary Allometry
allom.sp <- lm.rrpp(LS.mns~sz.mn, Cov = C)
allom.ind <- lm.rrpp(shape~svl, data = rdf)
anova(allom.sp)
anova(allom.ind)
M <-rbind(coef.evol <- allom.sp$LM$gls.coefficients[2,],
coef.ind <- allom.ind$LM$coefficients[2,])
acos(RRPP:::vec.cor.matrix(M))*180/pi  #virtually parallel (angle of 1.49 degrees)
# 2: MANCOVA & comparison of allometry among habitats
fit.hab <- lm.rrpp(shape~svl*habitat, data = rdf)
anova(fit.hab)
pw.hab1 <- pairwise(fit.hab, groups = rdf$habitat, covariate = rdf$svl)
summary(pw.hab1, type = 'VC', stat.table = FALSE)
# 2A: Compare habitat vectors versus isometry and to each other
#H_0: isometry as common slope model
mn.sz <- tapply(rdf$svl,rdf$habitat,mean)
mn.shape <- rowsum(rdf$shape, rdf$habitat)/as.vector(table(rdf$habitat))
intercepts <- mn.shape - t(tcrossprod(coef.iso,mn.sz))
X <- model.matrix(~rdf$svl+rdf$habitat)
# 2A: Compare habitat vectors versus isometry and to each other
#H_0: isometry as common slope model
mn.sz <- tapply(rdf$svl,rdf$habitat,mean)
mn.shape <- rowsum(rdf$shape, rdf$habitat)/as.vector(table(rdf$habitat))
intercepts <- mn.shape - t(tcrossprod(coef.iso,mn.sz))
coef.iso <- c(1,1,1,1,1,1,1,1)
intercepts <- mn.shape - t(tcrossprod(coef.iso,mn.sz))
X <- model.matrix(~rdf$svl+rdf$habitat)
b <- rbind(intercepts[1,],coef.iso,intercepts[2,]-intercepts[1,],
intercepts[3,]-intercepts[1,])
preds <- X%*%b
E.iso <- rdf$shape - preds
perms <- RRPP:::perm.index(n = fit.hab$LM$n, iter = 999)
slopes <- list()
for(j in 1:1000){
slopes[[j]] <- pairwise(lm.rrpp((preds+E.iso[perms[[j]],]) ~ rdf$svl*rdf$habitat, iter=0),
groups = rdf$habitat,covariate = rdf$svl)$slopes[[1]]
}
slp.ang <- lapply(1:1000, function(j) acos(RRPP:::vec.cor.matrix(rbind(slopes[[j]],coef.iso)))*180/pi)
slp.hab.obs <- slp.ang[[1]]
slp.Z <- RRPP:::effect.list(slp.ang)
slp.P <- RRPP:::Pval.list(slp.ang)
slp.hab.obs
slp.Z
b <- rbind(intercepts[1,],coef.iso,intercepts[2,]-intercepts[1,],
intercepts[3,]-intercepts[1,])
slp.P
# 2B: Compare evolutionary and static (habitat) allometry
#H_0: isometry
slp.ang.ev <- lapply(1:1000, function(j) acos(RRPP:::vec.cor.matrix(rbind(coef.evol,slopes[[j]])))*180/pi)
slp.hab.ev.obs <- slp.ang.ev[[1]]
slp.Z.ev <- RRPP:::effect.list(slp.ang.ev)
slp.P.ev <- RRPP:::Pval.list(slp.ang.ev)
slp.hab.ev.obs
slp.Z.ev
slp.P.ev  #not different from evol. allometry
slp.hab.obs
slp.Z
slp.P
res
slp.hab.ev.obs
slp.Z.ev
slp.P.ev  #not different from evol. allometry
res <- cbind(slp.hab.ev.obs[-1,1],slp.Z.ev[-1,1],slp.P.ev[-1,1])
colnames(res) <- c("Angle","Effect Size", "P-value")
rownames(res) <- c("Ground", "Rock", "Tree")
res
rownames(res) <- c("Ev-Ground", "EV-Rock", "EV-Tree")
res
rownames(res) <- c("Ev vs. Ground", "EV-Rock", "EV-Tree")
res
rownames(res) <- c("Ev vs. Ground", "Ev vs. Rock", "Ev vs. Tree")
res
